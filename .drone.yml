workspace:
  base: /bzmoon
  path: ${DRONE_REPO_SLUG}

pipeline:
  bundler:
    image: docker.studynator.me/bzone/bztools:latest
    when:
      event:
        - tag
    commands:
      - mkdir -p /tmp/bzmoon
      - mkdir -p /tmp/bzmoon2
      - moonc /bzmoon/src
      - curl -O https://raw.githubusercontent.com/bjornbytes/RxLua/master/rx.lua
      - mv rx.lua /tmp/bzmoon
      - find /bzmoon -type f \( -name "*.lua" -o -name "*.squish" \) -exec cp {} /tmp/bzmoon \;
      - cp /tmp/bzmoon/* /tmp/bzmoon2
      - python3 /bztools/luaSquish.py /tmp/bzmoon2 -r
      - mv /tmp/bzmoon2/* /tmp/bzmoon
      - zip -j -r /tmp/bundle.zip /tmp/bzmoon -i '*.lua'
      - \cp -f /tmp/bundle.zip /drone/deploy/bzmoon_${DRONE_TAG}.zip || true
    volumes:
      - /root/studynator/nginx-fs/public/bzmoon/:/drone/deploy

